# CVE-2020-13277

> CVE-2020-13277 靶场： 任意用户越权执行 Gitlab Pipeline Jobs 漏洞

------

## 靶场环境

![](https://img.shields.io/badge/Docker-latest-brightgreen.svg) ![](https://img.shields.io/badge/GitlabEE-10.6.0-brightgreen.svg) ![](https://img.shields.io/badge/Runner-latest-brightgreen.svg)


## 前置说明

此漏洞核心主要是利用 [Mirror Repository](https://docs.gitlab.com/ee/user/project/repository/repository_mirroring.html) - 仓库的镜像同步备份功能。

其中 Mirror 的同步方向又分两种：

- Pull：把指定 Repository 内容拉到当前 Repository
- Push：把当前 Repository 内容推到指定 Repository

> 此漏洞利用的是 Pull 方向的 Mirror Repository

要知道，Gitlab 分为 CE（社区免费版）和 EE（企业收费版）两种版本，而 Gitlab [官方也声称](https://gitlab.com/gitlab-org/cves/-/blob/master/2020/CVE-2020-13277.json) 此漏洞会同时影响 CE 和 EE 的以下版本：

- `>=10.6, <12.9.10`
- `>=12.10, <12.10.11`
- `>=13.0, <13.0.6`

但并不意味着这些版本的 [Gitlab Docker Image](https://hub.docker.com/search?q=gitlab) 都可以用于搭建靶场，这是因为：

- CE 版的 Mirror Repository 只有 Push 方向
- EE 版又细分为 Core、Starter、Premium、Ultimate 四个版本，从官方提供的[功能对比表](https://about.gitlab.com/pricing/self-managed/feature-comparison/)可知：只有 Core 版本是不存在 Pull 方向的，而 Gitlab-EE 的 Docker Image 均只提供是 Core 版本


换而言之，要使用 Docker 搭建半场，只能选用 Gitlab-EE 版，并将其[破解](https://blog.starudream.cn/2020/01/19/6-crack-gitlab/)（壕也可以选择购买 License）以激活 Mirror Repository - Pull 功能。


但即使破解了 Gitlab-EE，对于 12.x 和 13.x 版本是不支持在本地使用 Mirror Repository - Pull 功能的：当 Pull 的 Repository URL 包含本地路径时，会报错 `Import url is blocked: Requests to localhost are not allowed`。

虽然试图通过 Admin area => Settings => Network => Outbound requests 设置 `Allow requests to the local network from hooks and services`，但依旧无法 Pull Local Repository，会报错 `2:Fetching remote upstream failed: fatal: unable to access http://127.0.0.1/xxxx/: The requested URL returned error: 301`。只有 Pull Remote Repository 可用。


综上可知，最终只能采用 [gitlab-ee:10.6.0-ee.0](https://hub.docker.com/layers/gitlab/gitlab-ee/10.6.0-ee.0/images/sha256-1895df14d31443c8642a2564cdc3fad6948a89df09e616376b10d1b1971a75f8?context=explore) 版本的 Docker Image 构建此靶场。


## 靶场说明




首页为
http://127.0.0.1:8080/

默认登录账号 root

在这个页面可以创建新用户
http://127.0.0.1:8080/admin/users

gitlab 默认创建用户后，会邮件推送随机密码给该用户，要求该用户登录后修改密码。
避免麻烦， root 可以在创建用户后，直接编辑该用户，修改其密码。



需要两台服务器才能验证靶场
Mirroring repositories: 
 Import url is blocked: Requests to localhost are not allowed



验证过程
https://gitlab.com/gitlab-org/gitlab/-/issues/220972
https://www.cnblogs.com/zhongyuanzhao000/p/11379098.html  (加载特效)